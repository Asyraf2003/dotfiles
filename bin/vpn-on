#!/bin/bash
# ProtonVPN WireGuard - vpn-on (versi final 100% sesuai data Asyraf)
set -e
echo "[+] Starting ProtonVPN (WireGuard)..."

EP="185.177.125.13"      # Endpoint dari config kamu
GW="192.168.8.1"         # Gateway sesuai koneksi real
DEV="wlp2s0"             # Interface real kamu
IFACE="asyraf"
CONF="/etc/wireguard/asyraf.conf"
PEER_PUB="jJilN4ZNv7G6Cs64Rv422Ar05/qWNw0l4cXQ8n/O5Vg="

# 1) Backup DNS kalau belum ada
if [ -f /etc/resolv.conf ]; then
  sudo cp -n /etc/resolv.conf /etc/resolv.conf.backup 2>/dev/null || true
fi

# 2) Pastikan WG tidak mengubah DNS
sudo sed -i '/^[[:space:]]*DNS[[:space:]]*=/d' "$CONF" || true

# 3) Pastikan route ke endpoint agar tidak "unreachable"
sudo ip route replace "$EP" via "$GW" dev "$DEV"
echo "[+] Static route -> $EP via $GW dev $DEV"

# 4) Naikkan WireGuard
sudo wg-quick up "$IFACE"

# 5) Set keepalive agar stabil di Wi-Fi/NAT
sudo wg set "$IFACE" peer "$PEER_PUB" persistent-keepalive 25 || true

echo "[+] VPN aktif tanpa mengubah DNS lokal."
